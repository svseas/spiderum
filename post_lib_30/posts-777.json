{"_id":18191,"tags":[],"up_point":35,"down_point":0,"title":"Tự động hóa nhà (II): Nhiệt kế + Ẩm kế và Apple HomeKit","body":"<div><span style=\"background-color: initial;\">Cuối tuần này Cali trời mưa lạnh, chẳng biết làm gì. Tôi đành phải giở tiếp công trình lâu đài cát của mình là hệ thống tự động hóa trong nhà để thêm chức năng.&nbsp;</span><a href=\"http://wasabi.spiderum.com/bai-dang/Chua-benh-luoi-bang-MQTT-Raspberry-Pi-va-ESP32-dc7\" rel=\"noopener noreferrer\" target=\"_blank\">Tôi đã viết về hệ thống này trước đó</a><span style=\"background-color: initial;\">. </span><span style=\"background-color: initial;\">Kỳ trước, tôi đã điều khiển được chiếc đèn ngủ trong phòng. Kỳ này, tôi quyết định thêm cho nó chức năng báo nhiệt độ và độ ẩm. Tôi lâu nay có một chiếc sensor nhiệt kế kiêm ẩm kế (AM2301) mua ở AliExpress giá 3-4 đô gì đó (</span><a href=\"https://www.amazon.com/AM2301-Digital-Temperature-Humidity-Arduino/dp/B00R4KGG6Q\" rel=\"noopener noreferrer\" style=\"background-image:linear-gradient(rgba(0, 0, 0, 0.6) 50%, transparent 50%);\" target=\"_blank\">link Amazon</a><span style=\"background-color: initial;\">). Phen này chuyến phiêu lưu của tôi là làm sao đo được độ ẩm trong ngoài nhà bằng chiếc ẩm kế này.</span></div><div><span style=\"background-color: initial;\">Để các bạn tiện theo dõi, tôi xin liệt kê các linh kiện tôi đang có trong thiết kế này:</span></div><div><span style=\"background-color: initial;\">- 1 x bo mạch&nbsp;</span><a href=\"https://www.aliexpress.com/store/product/LOLIN-D32-Pro-V2-0-0-wifi-bluetooth-board-based-ESP-32-esp32-Rev1-ESP32-WROVER/1331105_32883116057.html\" rel=\"noopener noreferrer\" target=\"_blank\"><span style=\"background-color: initial;\">Lolin ESP32 Pro</span></a><span style=\"background-color: initial;\">&nbsp;của Wemos giá 10 USD.</span></div><div><span style=\"background-color: initial;\">- 1 x&nbsp;</span><a href=\"https://www.adafruit.com/product/268\" rel=\"noopener noreferrer\" target=\"_blank\"><span style=\"background-color: initial;\">PowerSwitch Tails</span></a><span style=\"background-color: initial;\">&nbsp;(nếu không mua được ở Việt Nam, bạn có thể thay thế bằng một chiếc&nbsp;</span><span style=\"background-color: initial;\"><a href=\"https://www.aliexpress.com/item/OOTDTY-1PCS-1-Channel-3V-Relay-Module-3-3V-Low-Level-Shooting-with-Lamp/32860095714.html?spm=2114.search0104.3.8.3e1649b4XvauoM&ws_ab_test=searchweb0_0,searchweb201602_3_10065_10130_10068_10890_10547_319_10546_317_10548_10545_10696_453_10084_454_10083_10618_10307_537_536_10059_10884_10887_100031_321_322_10103-10890,searchweb201603_52,ppcSwitch_0&algo_expid=702191a0-d486-46d2-9ee4-c924b83827a2-1&algo_pvid=702191a0-d486-46d2-9ee4-c924b83827a2&transAbTest=ae803_3\" rel=\"noopener noreferrer\" target=\"_blank\">Relay như thế này</a> - Cần chế tiếp một cái vỏ cho nó hoặc gắn vào trong một chiếc dây nối dài - Cẩn thận điện giật</span><span style=\"background-color: initial;\">).</span></div><div>- Một số <a href=\"https://www.aliexpress.com/item/Free-shipping-Dupont-line-120pcs-20cm-male-to-male-male-to-female-and-female-to-female/1899750504.html?spm=a2g0s.9042311.0.0.27424c4dJupHWG\" rel=\"noopener noreferrer\" target=\"_blank\">dây nối nhỏ</a>.</div><div><span style=\"background-color: initial;\">Trước tiên công việc của chúng ta là kết nối chiếc sensor này vào hệ thống vi điều khiển - microcontroller - hiện tại.&nbsp;</span></div><div><figure class=\"aligncenter\"><img src=\"https://s3-ap-southeast-1.amazonaws.com/img.spiderum.com/sp-images/c3073170124611e9a44451e64514e1a0.png\" class=\"fr-fic fr-dib\"><figcaption class=\"image-description\" contenteditable=\"false\" placeholder=\"Chú thích ảnh (không bắt buộc)\"><br></figcaption></figure></div><div>Hiện tại chiếc Power Tails đã dùng pin 5. Chúng ta có thể tiếp tục dùng các pin còn rỗi của bo mạch này. Tôi chọn pin 2. Việc còn lại là nối VCC (3.3V - sensor này chạy 3.3V hay 5V đều được) và đất - Ground. Sơ đồ kết nối như hình vẽ ở trên. Trên thực tế thì nó như thế này:</div><div><figure class=\"aligncenter\"><img src=\"https://s3-ap-southeast-1.amazonaws.com/img.spiderum.com/sp-images/c3d918b0124c11e9a44451e64514e1a0.jpg\" class=\"fr-fic fr-dib\"><figcaption class=\"image-description\" contenteditable=\"false\" placeholder=\"Chú thích ảnh (không bắt buộc)\"><br></figcaption></figure></div><div>Việc lập trình để đọc nhiệt độ từ sensor xem ra khó khăn hơn tôi tưởng. Nếu dùng Arduino, thì LadyAda đã viết thư viện sẵn <a href=\"https://learn.adafruit.com/dht\" rel=\"noopener noreferrer\" target=\"_blank\">ở đây</a>. Nhưng tôi không dùng Arduino mà dùng SDK chính thức của ESP32, vốn dựa vào <a href=\"https://www.freertos.org/\" rel=\"noopener noreferrer\" target=\"_blank\">FreeRTOS</a>. Như vậy là tôi phải dùng C. May mắn, sau khi Google một lúc thì tôi thấy <a href=\"https://github.com/UncleRus/esp-idf-lib/blob/master/components/dht/dht.c\" rel=\"noopener noreferrer\" target=\"_blank\">có người đã viết thư viện cho chiếc sensor này bằng C cho ESP32</a>.</div><div>Lưu ý: Đoạn dưới đây sẽ rất khó hiểu cho bạn nào chưa từng làm việc với các thiết bị điện tử. Nếu bạn không hiểu, bỏ qua đoạn này.</div><div><strong>** Bắt đầu đoạn khó hiểu **&nbsp;</strong>Chỉ đọc nếu bạn thật sự muốn hiểu cơ chế hoạt động của chiếc sensor này như thế nào.</div><div>Thông thường việc đầu tiên khi viết mã nguồn để giao tiếp với một chiếc sensor hay một thiết bị điện tử mà mình chưa bao giờ tiếp xúc là <a href=\"http://www.adafruit.com/datasheets/DHT22.pdf\" rel=\"noopener noreferrer\" target=\"_blank\">đọc Datasheet</a>.</div><div>Thông thường các giao thức điện tử đều dùng hai dây, một gửi và một nhận. Điều đặc biệt của chiếc sensor này là nó dùng giao thức 1-wire, tức là cả truyền lẫn nhận dữ liệu đều trên một dây. Khi nào vi điều khiển muốn kiểm tra nhiệt độ từ sensor thì phải \"thông báo\" cho sensor bằng cách kéo tín hiệu xuống thấp, rồi nâng lên cao, rồi chờ xem sensor có trả lời bằng cách kéo lại xuống thấp không.</div><div><br><figure class=\"aligncenter\"><img src=\"https://s3-ap-southeast-1.amazonaws.com/img.spiderum.com/sp-images/67724c80124811e9b30be9c1dfb85f0f.png\" class=\"fr-fic fr-dib\"><figcaption class=\"image-description\" contenteditable=\"false\" placeholder=\"Chú thích ảnh (không bắt buộc)\"><br></figcaption></figure></div><div>Điều kì lạ là tôi nhận được lỗi sau:</div><div><figure class=\"aligncenter\"><img src=\"https://s3-ap-southeast-1.amazonaws.com/img.spiderum.com/sp-images/dff5e450124811e9a88003817670d069.png\" class=\"fr-fic fr-dib\"><figcaption class=\"image-description\" contenteditable=\"false\" placeholder=\"Chú thích ảnh (không bắt buộc)\"><br></figcaption></figure></div><div>Phase B khi đọc mã nguồn thì tôi thấy là lúc vi điều khiển muốn xem sensor có trả lời không:</div><div><br><figure class=\"aligncenter\"><img src=\"https://s3-ap-southeast-1.amazonaws.com/img.spiderum.com/sp-images/50d798d0124911e99a8a5f9109c8a077.png\" class=\"fr-fic fr-dib\"><figcaption class=\"image-description\" contenteditable=\"false\" placeholder=\"Chú thích ảnh (không bắt buộc)\"><br></figcaption></figure></div><div>Sau khi dành ra 5 giờ đồng hồ để debug và càu nhàu không biết làm sao thư viện này không chạy (tôi đã thử sensor này với một thư viện khác với một bo mạch khác, chạy tốt) thì tôi nhận ra một điều là mình đã sử dụng pin 15. Đây là một chân đặc biệt của vi điều khiển ESP32. Khi sử dụng pin này có vẻ như ESP32 sẽ không chạy như bình thường. Khi tôi chuyển sang pin 2 thì mọi thứ chạy hầu như là tốt. Tôi có thay đổi một chút mã nguồn để&nbsp;thư viện chạy ổn định hơn, nhưng không có gì quá phức tạp.</div><div><strong>** Kết thúc đoạn khó hiểu **</strong></div><div>Bạn cũng không cần hiểu cụ thể sensor giao tiếp với mạch vi điện tử ra sao nếu có người như tôi đã viết và đã giải quyết vấn đề cho bạn. Với tư cách một lập trình viên, bạn chỉ cần biết cần gọi cái gì vào lúc nào.</div><div>Cách dễ nhất là <a href=\"https://github.com/UncleRus/esp-idf-lib/blob/master/examples/dht/main/main.c\" rel=\"noopener noreferrer\" target=\"_blank\">xem ví dụ</a>. Như vậy, chỉ cần gọi \"dht_read_data\":</div><pre>dht_read_data(sensor_type, dht_gpio, &humidity, &temperature)</pre><div>Vấn đề còn lại là chạy một \"task\" (ý tưởng như \"thread\" khi lập trình song song), để truy vấn nhiệt độ một cách thường xuyên (15 giây thì cập nhật một lần). Đoạn mã này chạy trong một vòng lặp, và publish dữ liệu lên server MQTT cứ 15 giây một lần:</div><div><div><figure class=\"aligncenter\"><img src=\"https://s3-ap-southeast-1.amazonaws.com/img.spiderum.com/sp-images/1f2614a0124a11e9a88003817670d069.png\" class=\"fr-fic fr-dib\"><figcaption class=\"image-description\" contenteditable=\"false\" placeholder=\"Chú thích ảnh (không bắt buộc)\"><br></figcaption></figure></div><div>Và, sau khi configure homebridge-mqttthing, kết quả là Apple HomeKit đã đọc được nhiệt độ và độ ẩm của phòng tôi.</div><div><br><figure class=\"aligncenter\"><img src=\"https://s3-ap-southeast-1.amazonaws.com/img.spiderum.com/sp-images/af7d6a70124b11e9b30be9c1dfb85f0f.png\" class=\"fr-fic fr-dib\"><figcaption class=\"image-description\" contenteditable=\"false\" placeholder=\"Chú thích ảnh (không bắt buộc)\"><br></figcaption></figure></div><div>Dĩ nhiên, Siri vẫn thông minh như thường.</div><div><br><figure class=\"aligncenter\"><img src=\"https://media.giphy.com/media/65OGqN71dBve2RySKl/giphy.gif\" class=\"fr-fic fr-dib\"><figcaption class=\"image-description\" contenteditable=\"false\" placeholder=\"Chú thích ảnh (không bắt buộc)\"><br></figcaption></figure></div><div><br></div><div>Tôi có để mã nguồn cho dự án mà mình đang sử dụng ở đây: <a href=\"https://github.com/htruong/esp32_room_automation\" target=\"_blank\">https://github.com/htruong/esp32_room_automation</a>. Chỉ việc clone repository này là bạn có thể làm theo và có một căn phòng thông minh, có đèn ngủ và sensor điều khiển bằng giọng nói.</div></div><div>Cũng may chế điện tử cả ngày làm cho thời gian trôi vun vút không như Sài Gòn, nếu không tôi đã khóc một giòng sông (sic)...</div><div><span class=\"fr-video fr-fvc fr-dvb fr-draggable\" contenteditable=\"false\" draggable=\"true\"><iframe width=\"640\" height=\"360\" src=\"//www.youtube.com/embed/S8LnmGZdWL4?wmode=opaque\" frameborder=\"0\" allowfullscreen=\"\"></iframe></span></div><div>TB: Làm những việc như vậy ngay cả một người tương đối có kinh nghiệm như tôi cũng mất cả ngày lẩm bẩm chửi rủa mãi mới nhận ra mình sai chỗ nào. Khi bạn muốn làm được những việc như thế này, điều quan trọng nhất là nhận ra mọi việc sẽ rất tốn thời gian. Người ta nói để hiểu và làm được một việc gì tốt cũng phải bỏ ra 10,000 giờ, quả là không sai.</div>","cat_id":{"_id":12,"name":"Khoa học - Công nghệ"},"creator_id":23056,"created_at":"2019-01-07T07:27:40.009Z"}